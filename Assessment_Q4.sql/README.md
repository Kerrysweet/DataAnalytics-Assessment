# Customer Lifetime Value (CLV) Estimation Query

### 1. customer_transaction_profits CTE

Goal: To calculate the total number of successful transactions and the total profit generated by each customer.

Approach:

 Uniting Transaction Sources: 
 combine data from two tables: savings_savingsaccount (representing successful savings transactions) and withdrawals_withdrawal (representing successful withdrawal transactions).
 
 Calculating Transaction Profit: For savings, the transaction_profit is calculated as 0.1% (0.001) of the confirmed_amount. For withdrawals, it's calculated as 0.1% of the amount_withdrawn. This assumes a 0.1% profit margin on each successful transaction.

## Filtering Successful Transactions: 
The WHERE clause in each sub-query filters for transactions with a successful status in the savings_savingsaccount table and transactions with specific successful status IDs (which need to be replaced) in the withdrawals_withdrawal table. It also ensures that confirmed_amount and amount_withdrawn are greater than zero.

## Grouping by Customer:
 Finally, the results are grouped by owner_id to aggregate the total_transactions (count of id) and total_profit (sum of transaction_profit) for each customer.

### 2. customer_data CTE

Goal: To combine customer demographic information with their transaction history and total profit.

Approach:

## Selecting Customer Information:
 This CTE selects the customer's id (aliased as customer_id), first_name, last_name, and date_joined from the users_customuser table.

## Joining with Transaction Data:
 A LEFT JOIN is used to combine the users_customuser table with the customer_transaction_profits CTE using the owner_id from customer_transaction_profits and the id from users_customuser. A LEFT JOIN ensures that all customers are included in the result, even if they have no transaction history (in which case total_transactions and total_profit will be NULL).

## Handling Missing Transaction Data:
COALESCE is used to replace NULL values for total_transactions and total_profit with 0. This ensures that customers with no transactions are still included in the final result with a transaction count and profit of zero. The total_profit is aliased as total_profit_kobo, implying the profit is initially calculated in kobo.

### 3. Final SELECT Statement

Goal: To calculate the estimated Customer Lifetime Value (CLV) for each customer.

Approach:

Selecting Customer Identifiers:
 The query selects the customer_id and concatenates first_name and last_name to create the customer_name.

Calculating Account Tenure: TIMESTAMPDIFF(MONTH, date_joined, '2025-05-19')` calculates the duration (in months) since the customer joined until the specified date ('2025-05-19'). This provides the customer's tenure with the platform.

Estimating Annual Transaction Profit per Customer:** The core of the CLV estimation lies in the CASE statement.
    Condition for Calculation:
     It checks if the account_tenure_months is greater than 0 and the total_transactions is greater than 0 to avoid division by zero.
    
    CLV Calculation Logic:
     If the condition is met, the estimated annual profit per customer is calculated as follows:
    
        (total_transactions / account_tenure_months) * 12 * (total_profit_kobo / total_transactions)
    